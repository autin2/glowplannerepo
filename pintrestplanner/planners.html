<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Planners — GlowPlanner</title>
  <meta name="description" content="Browse GlowPlanner templates. Download is gated for Pro members."/>
  <link rel="stylesheet" href="style.css"/>

  <!-- Supabase browser client + public envs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/api/env.js"></script>

  <style>
    /* Middle header links */
    .mid-links{
      display:flex; gap:20px; align-items:center; justify-content:center; flex:1;
    }
    .mid-link{
      font-weight:500; color:var(--text,#eef1ff); text-decoration:none;
      padding:6px 10px; border-radius:6px; transition:background .2s,color .2s;
    }
    .mid-link:hover{ background:rgba(255,255,255,.08); color:#fff }

    /* Catalog */
    .wrap{ max-width:1100px; margin:32px auto; padding:0 20px; }
    .page-title{ font-size:28px; font-weight:800; margin:0 0 6px }
    .muted{ color:#aeb3d7 }
    .catalog{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:18px;
      margin-top:18px;
    }
    @media (max-width: 1100px){
      .catalog{ grid-template-columns: repeat(8, 1fr); }
    }
    @media (max-width: 760px){
      .catalog{ grid-template-columns: repeat(4, 1fr); }
    }

    .card{
      grid-column: span 3; /* 4 cards per row on desktop */
      background: #0f1222;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      overflow: hidden;
      display: flex; flex-direction: column;
    }
    @media (max-width: 1100px){ .card{ grid-column: span 4; } } /* 2 per row tablet */
    @media (max-width: 760px){ .card{ grid-column: span 4; } }  /* 1 per row phone */

    .thumb{
      position: relative;
      aspect-ratio: 3/4; /* poster-like */
      background: #111633;
      display: grid; place-items:center;
      overflow:hidden;
    }
    .thumb img{
      width: 100%; height: 100%; object-fit: cover; display:block;
    }
    .pill{
      position:absolute; top:10px; left:10px;
      background: rgba(255,255,255,.12);
      color: #fff; font-size: 11px; font-weight:700; padding:5px 8px; border-radius:999px;
      backdrop-filter: blur(4px);
    }
    .pill.pro{ background: linear-gradient(135deg,#ff7ac8,#ff66a8); color:#111 }
    .body{ padding: 14px; display:flex; flex-direction:column; gap:8px }
    .title{ font-weight: 700 }
    .desc{ font-size: 13px; color: #c9cde9 }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#151a35; color:#eef1ff; cursor:pointer }
    .btn.primary{ background:#6c7bff; border-color:transparent }
    .btn.ghost{ background:transparent }
    .badge{ font-size:11px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08); color:#e8ebff }
  </style>
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <!-- Left: Brand -->
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <span>GlowPlanner</span>
      </div>

      <!-- Middle: New nav links -->
      <nav class="mid-links" aria-label="Main navigation">
        <a href="/index.html" class="mid-link">Home</a>
        <a href="/planners.html" class="mid-link" aria-current="page">Planners</a>
        <a href="/editor.html" class="mid-link">Editor</a>
      </nav>

      <!-- Right: Account / Sign in -->
      <div class="nav-cta" id="navCta">
        <button class="btn ghost" id="btnSignIn">Sign In</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <h1 class="page-title">Planners</h1>
    <div class="muted">Browse templates. Downloading requires Pro.</div>

    <section class="catalog" id="catalog">
      <!-- Cards populated below — using image placeholders and sample files -->
    </section>
  </main>

  <footer>
    <div class="container foot">
      <div class="brand"><div class="logo"></div><span>GlowPlanner</span></div>
      <div class="fine">© <span id="y"></span> GlowPlanner. Pretty planners, practical habits.</div>
    </div>
  </footer>

  <!-- Reusable Sign-in Modal -->
  <div class="modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginTitle" aria-hidden="true" style="display:none">
    <div class="modal-backdrop" data-close></div>
    <div class="modal-panel" tabindex="-1">
      <div class="modal-head">
        <div class="brand">
          <span class="brand-pill">GlowPlanner</span>
          <span id="loginTitle">Sign in</span>
        </div>
        <button class="xbtn" title="Close" data-close aria-label="Close">✕</button>
      </div>

      <form id="loginForm" onsubmit="event.preventDefault()">
        <div class="field">
          <label for="email">Email</label>
          <input id="email" name="email" type="email" autocomplete="email" placeholder="you@example.com" required/>
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input id="password" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required/>
        </div>

        <div class="row" style="justify-content: space-between; margin: 6px 0 14px">
          <label class="row" style="gap:8px; font-size:12px; color:#b8bde6">
            <input type="checkbox" id="remember" style="accent-color:#7e8bff"/> Remember me
          </label>
          <a href="#" id="linkForgot" class="muted">Forgot?</a>
        </div>

        <button class="btn primary" id="btnEmailPw" style="width:100%">Continue</button>
        <div class="hr"></div>
        <button type="button" class="oauth" id="btnGoogle">Continue with Google</button>
        <p class="legal">By continuing, you agree to our <a href="#">Terms</a> and <a href="#">Privacy</a>.</p>
        <p class="muted" id="authNote" style="margin-top:8px;"></p>
      </form>
    </div>
  </div>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    // Init Supabase
    const supabase = window.supabase.createClient(
      window.ENV?.SUPABASE_URL || "",
      window.ENV?.SUPABASE_ANON_KEY || "",
      { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
    );

    // Navbar session-aware CTA
    async function renderNav(){
      const { data: { session } } = await supabase.auth.getSession();
      const navCta = document.getElementById('navCta');
      navCta.innerHTML = '';

      if (session) {
        const a = document.createElement('a');
        a.className = 'btn ghost';
        a.href = '/account.html';
        a.textContent = 'Account';
        navCta.appendChild(a);
      } else {
        const btn = document.createElement('button');
        btn.className = 'btn ghost';
        btn.id = 'btnSignIn';
        btn.textContent = 'Sign In';
        navCta.appendChild(btn);
        btn.addEventListener('click', openModal);
      }
    }

    // Mock "plan" since Stripe isn't set up (force non-Pro)
    let CURRENT_PLAN = 'Free';
    function isPro(){ return CURRENT_PLAN === 'Pro'; }

    // Catalog data (replace thumbs & files with your real assets)
    const items = [
      { key:'meal-plan', title:'Meal Plan', desc:'Plan breakfasts, lunches, dinners + grocery list.', pro:true, thumb:'/img/mock-glowplanner-v4.png', file:'/pdfs/meal-plan.pdf' },
      { key:'fitness', title:'Fitness', desc:'Weekly workouts with sets, reps, and notes.', pro:true, thumb:'/img/mock-glowplanner-v4.png', file:'/pdfs/fitness.pdf' },
      { key:'budget', title:'Budget', desc:'Monthly budget, savings, and expense tracker.', pro:true, thumb:'/img/mock-glowplanner-v4.png', file:'/pdfs/budget.pdf' },
      { key:'self-care', title:'Self-Care', desc:'Routines for skin, sleep, relaxation, joy.', pro:true, thumb:'/img/mock-glowplanner-v4.png', file:'/pdfs/self-care.pdf' },
      { key:'daily', title:'Daily Planner', desc:'Top 3, schedule, priorities, and notes.', pro:true, thumb:'/img/mock-glowplanner-v4.png', file:'/pdfs/daily-planner.pdf' },
      { key:'weekly-reset', title:'Weekly Reset', desc:'Declutter, plan, reflect, and reset.', pro:true, thumb:'/img/mock-glowplanner-v4.png', file:'/pdfs/weekly-reset.pdf' },
      { key:'cleaning', title:'Cleaning', desc:'Room-by-room checklists and cadence.', pro:true, thumb:'/img/mock-glowplanner-v4.png', file:'/pdfs/cleaning.pdf' },
      { key:'habit', title:'Habit Tracker', desc:'Track habits with weekly/monthly grids.', pro:true, thumb:'/img/mock-glowplanner-v4.png', file:'/pdfs/habit-tracker.pdf' },
    ];

    function cardTemplate(item){
      return `
        <article class="card" data-key="\${item.key}">
          <div class="thumb">
            <img src="\${item.thumb}" alt="\${item.title} preview"/>
            <span class="pill \${item.pro ? 'pro' : ''}">\${item.pro ? 'Pro' : 'Free'}</span>
          </div>
          <div class="body">
            <div class="title">\${item.title}</div>
            <div class="desc">\${item.desc}</div>
            <div class="row">
              \${item.pro ? '' : '<span class="badge">Free</span>'}
              <button class="btn" data-dl="\${item.file}">Download</button>
            </div>
          </div>
        </article>
      `;
    }

    function renderCatalog(){
      const el = document.getElementById('catalog');
      el.innerHTML = items.map(cardTemplate).join('');
      // bind download buttons
      el.querySelectorAll('button[data-dl]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const file = btn.getAttribute('data-dl');

          // Check session
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) { openModal(); return; }

          // Check Pro
          if (!isPro()){
            const go = confirm('This template requires Pro. Go to billing to upgrade?');
            if (go) window.location.href = '/account.html';
            return;
          }

          // Start download if allowed
          startDownload(file);
        });
      });
    }

    function startDownload(file){
      const a = document.createElement('a');
      a.href = file;
      a.download = file.split('/').pop();
      document.body.appendChild(a); a.click(); a.remove();
    }

    // Modal logic
    const loginModal = document.getElementById('loginModal');
    const closeEls = loginModal.querySelectorAll('[data-close]');
    const emailEl = document.getElementById('email');
    const pwEl = document.getElementById('password');
    const note = document.getElementById('authNote');
    let lastFocus = null;

    function openModal(){ lastFocus = document.activeElement; loginModal.style.display='grid'; loginModal.classList.add('open'); loginModal.removeAttribute('aria-hidden'); setTimeout(()=>emailEl.focus(),0); }
    function closeModal(){ loginModal.classList.remove('open'); loginModal.setAttribute('aria-hidden','true'); loginModal.style.display='none'; if(lastFocus) lastFocus.focus(); }
    closeEls.forEach(el => el.addEventListener('click', closeModal));
    loginModal.querySelector('.modal-backdrop').addEventListener('click', closeModal);
    loginModal.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });

    // Email/password (auto sign-up on first try)
    document.getElementById('btnEmailPw').addEventListener('click', async () => {
      note.textContent = 'Signing in...';
      const email = emailEl.value.trim();
      const password = pwEl.value;
      if(!email || !password){ note.textContent = 'Enter your email and password.'; return; }

      let { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error && /Invalid login credentials/i.test(error.message || '')) {
        ({ data, error } = await supabase.auth.signUp({ email, password }));
      }
      if (error) { note.textContent = 'Error: ' + (error.message || 'Something went wrong.'); return; }

      note.textContent = 'Success! You are signed in.';
      setTimeout(() => { closeModal(); renderNav(); }, 300);
    });

    // Google OAuth
    document.getElementById('btnGoogle').addEventListener('click', async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.origin }
      });
      if (error) note.textContent = 'Google sign-in error: ' + error.message;
    });

    // Hydrate page
    (async () => {
      await renderNav();
      // TODO: when backend exists, fetch real plan here and set CURRENT_PLAN accordingly.
      // const me = await (await fetch('/api/me', { method:'POST' })).json();
      // CURRENT_PLAN = me.plan || 'Free';
      renderCatalog();
    })();
  </script>
</body>
</html>

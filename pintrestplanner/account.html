<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Account — GlowPlanner</title>
  <meta name="description" content="Your GlowPlanner account overview and billing."/>
  <link rel="stylesheet" href="style.css"/>

  <!-- Supabase client + public envs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/api/env.js"></script>

  <style>
    :root{
      --bg:#0c0f1c; --card:#11142a; --text:#eef1ff; --muted:#aeb3d7;
      --line:rgba(255,255,255,.08); --brand:#ff7ac8; --primary:#6c7bff;
    }
    body{ background:var(--bg); color:var(--text); }
    .wrap{ max-width:960px; margin:40px auto; padding:0 20px; }
    .crumbs{ font-size:12px; color:var(--muted); margin-bottom:18px }
    .h1{ font-size:28px; font-weight:800; margin:0 0 16px }
    .muted{ color:var(--muted) }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px }
    .row{ display:flex; gap:16px; align-items:center }
    .sp{ justify-content:space-between }
    .tabs{ display:flex; gap:8px; border-bottom:1px solid var(--line); margin-top:18px }
    .tab{ padding:10px 14px; border:1px solid transparent; border-top-left-radius:10px; border-top-right-radius:10px; cursor:pointer; color:var(--muted) }
    .tab.active{ color:var(--text); border-color:var(--line); border-bottom-color:transparent; background:rgba(255,255,255,.02) }
    .panel{ display:none; padding:18px 0 }
    .panel.active{ display:block }
    .kpi{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:10px }
    .kpi .item{ background:rgba(255,255,255,.02); border:1px solid var(--line); border-radius:12px; padding:12px }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#1a1f3b; color:var(--text); cursor:pointer }
    .btn.primary{ background:var(--primary); border-color:transparent }
    .btn.ghost{ background:transparent }
    .btn.danger{ background:#2a1220; border-color:#3a1a2c }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:18px }
    @media (max-width: 820px){ .grid2{ grid-template-columns:1fr } }
    .badge{ font-size:11px; background:rgba(255,255,255,.06); padding:4px 8px; border-radius:999px }
    .list{ display:grid; gap:10px }
    .list .row{ justify-content:space-between; border-bottom:1px dashed var(--line); padding:10px 0 }
    .tiny{ font-size:12px }
    a { color:#cbd1ff }
  </style>
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <span>GlowPlanner</span>
      </div>
      <div class="nav-cta">
        <a class="btn ghost" href="/">Home</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="crumbs">Account</div>
    <div class="card">
      <div class="row sp">
        <div>
          <div class="h1">Your account</div>
          <div class="muted">Manage your plan and downloads.</div>
        </div>
        <div class="row" id="userQuick">
          <span class="badge" id="planBadge">Plan: —</span>
          <button class="btn danger" id="btnSignOut">Sign out</button>
        </div>
      </div>

      <div class="tabs" role="tablist">
        <button class="tab active" role="tab" aria-selected="true" aria-controls="panel-overview" id="tab-overview">Overview</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="panel-billing" id="tab-billing">Billing</button>
      </div>

      <!-- OVERVIEW -->
      <section class="panel active" id="panel-overview" role="tabpanel" aria-labelledby="tab-overview">
        <div class="grid2">
          <div class="item card">
            <h3 style="margin:0 0 8px">Profile</h3>
            <div class="muted tiny">We only store what we need to run your plan.</div>
            <div class="kpi">
              <div class="item">
                <div class="muted tiny">Email</div>
                <div id="kEmail">—</div>
              </div>
              <div class="item">
                <div class="muted tiny">User ID</div>
                <div id="kUserId" class="tiny">—</div>
              </div>
            </div>
          </div>

          <div class="item card">
            <h3 style="margin:0 0 8px">Downloads</h3>
            <div class="muted tiny">Recent exports from your account (coming soon).</div>
            <div class="list" id="dlList">
              <div class="row tiny"><span>7-Day Glow-Up (fillable)</span><span class="muted">—</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- BILLING -->
      <section class="panel" id="panel-billing" role="tabpanel" aria-labelledby="tab-billing">
        <div class="grid2">
          <div class="item card">
            <h3 style="margin:0 0 8px">Current plan</h3>
            <div class="muted tiny">Your active subscription & renewal.</div>
            <div class="kpi">
              <div class="item">
                <div class="muted tiny">Plan</div>
                <div id="kPlan">Free</div>
              </div>
              <div class="item">
                <div class="muted tiny">Renews</div>
                <div id="kRenews">—</div>
              </div>
            </div>
            <div style="margin-top:14px" class="row">
              <button class="btn primary" id="btnManage">Manage subscription</button>
              <span class="tiny muted">Opens Stripe customer portal.</span>
            </div>
          </div>

          <div class="item card">
            <h3 style="margin:0 0 8px">Invoices</h3>
            <div class="muted tiny">View and download past receipts in Stripe.</div>
            <div class="row" style="margin-top:12px">
              <button class="btn" id="btnPortal">Open billing portal</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // === Supabase init from /api/env.js ===
    const supabase = window.supabase.createClient(
      window.ENV?.SUPABASE_URL || "",
      window.ENV?.SUPABASE_ANON_KEY || "",
      { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
    );

    // --- Simple route guard: redirect to home + open modal if not logged in
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        // Not signed in → go home. You can also show a dedicated "Please sign in" page.
        window.location.href = '/';
        return;
      }
      hydrate(session);
    })();

    // --- Populate account data (mock plan for now)
    async function hydrate(session){
      const user = session.user;
      document.getElementById('kEmail').textContent = user.email || '—';
      document.getElementById('kUserId').textContent = user.id || '—';

      // TODO: call your backend to get real plan info
      // const res = await fetch('/api/me', { method: 'POST' });
      // const me = await res.json();
      const me = { plan: 'Free', renews_at: null }; // mock
      setPlan(me.plan, me.renews_at);
    }

    function setPlan(plan, renewsAt){
      document.getElementById('kPlan').textContent = plan || 'Free';
      document.getElementById('planBadge').textContent = 'Plan: ' + (plan || 'Free');
      document.getElementById('kRenews').textContent = renewsAt ? new Date(renewsAt).toLocaleDateString() : '—';
    }

    // --- Tabs
    const tabs = [...document.querySelectorAll('.tab')];
    const panels = [...document.querySelectorAll('.panel')];
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        panels.forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.id.replace('tab','panel')).classList.add('active');
      });
    });

    // --- Sign out
    document.getElementById('btnSignOut').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/';
    });

    // --- Billing actions (wire these to Stripe later)
    async function openPortal(){
      try{
        // EXPECTED backend: creates a customer if needed, returns portal URL
        const res = await fetch('/api/stripe-portal', { method:'POST' });
        if(!res.ok){ throw new Error('Portal request failed'); }
        const { url } = await res.json();
        if(url) window.location.href = url;
      }catch(e){
        alert('Billing portal is not set up yet. (Backend TODO)');
      }
    }
    document.getElementById('btnManage').addEventListener('click', openPortal);
    document.getElementById('btnPortal').addEventListener('click', openPortal);
  </script>
</body>
</html>
